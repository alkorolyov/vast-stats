<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uPlot Example</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/uplot@1.6.30/dist/uPlot.iife.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uplot@1.6.30/dist/uPlot.min.css">
</head>
<body>
    <div class="container">
        <form id="plot-form" class="bg-light p-2 rounded shadow">
            <div class="row" >
                <label for="machine-id" class="col-auto col-form-label-sm">Machine ID:</label>
                <div class="col-auto ">
                    <input type="text" id="machine-id" name="machine_id" class="form-control form-control-sm">
                </div>
                <label for="from-date" class="col-auto col-form-label-sm">From:</label>
                <div class="col-auto">
                    <input type="text" id="from-date" name="from_date" class="col-auto form-control form-control-sm">
                </div>
                <label for="to-date" class="col-auto col-form-label-sm">To:</label>
                <div class="col-auto">
                    <input type="text" id="to-date" name="to_date" class="form-control form-control-sm">
                </div>
                <div class="col-auto">
                    <button id="plot-button" type="submit" class="btn btn-primary btn-sm">Plot</button>
                </div>
                <div class="col-auto">
                    <div id="loading-spinner" class="spinner-border spinner-sm text-primary visually-hidden" role="status"></div>
                </div>
            </div>
        </form>
    </div>

    <div id="plot-container"></div>

    <script>

        const plotForm = document.getElementById("plot-form");
        const plotContainer = document.getElementById("plot-container");
        let plotInstance = null;

        // Function to show loading spinner and disable button
        function showLoading() {
            const plotButton = document.getElementById("plot-button");
            const loadingSpinner = document.getElementById("loading-spinner");

            plotButton.disabled = true;
            loadingSpinner.classList.remove("visually-hidden");
        }

        // Function to hide loading spinner and enable button
        function hideLoading() {
            const plotButton = document.getElementById("plot-button");
            const loadingSpinner = document.getElementById("loading-spinner");

            plotButton.disabled = false;
            loadingSpinner.classList.add("visually-hidden");
        }

        function getUrl(machineId, fromDate, toDate) {
            // Construct URL
            let url = `/stats`;

            if (machineId) {
                url += `?machine_id=${machineId}`;
            }
            if (fromDate) {
                url += `&from=${fromDate}`;
            }
            if (toDate) {
                url += `&to=${toDate}`;
            }
            return url;
        }

        // function updatePlot(plotData, machineId) {
        //     // update existing plot with new data
        //     plotInstance.setData(plotData);
        //     let plotTitle = document.getElementsByClassName("u-title");
        //     plotTitle[0].textContent = `machine_id: ${machineId}`;
        // }

        function createPlot(plotData, machineId) {
            const windowWidth = window.innerWidth * window.devicePixelRatio;
            const windowHeight = window.innerHeight * window.devicePixelRatio;

            let muSync = uPlot.sync("moo");

            const cursorOpts = {
                lock: true,
                focus: {
                    prox: 16,
                },
                sync: {
                    key: muSync.key,
                    setSeries: true,
                },
            };


            // Create and render plot with uPlot
            const opts1 = {
                width: windowWidth * 0.8, // 80% of window width
                height: windowHeight * 0.4, // 60% of window height
                title: `machine_id: ${machineId}`,
                cursor: cursorOpts,
                series: [
                    {},
                    {
                        label: "reliability",
                        scale: "%",
                        stroke: "red",
                        fill: "rgba(255,0,0,0.1)",
                        width: 1/window.devicePixelRatio,
                    },
                ],
            };
            let plotInstance1 = new uPlot(opts1, [plotData[0], plotData[1]], plotContainer);

            const opts2 = {
                width: windowWidth * 0.8, // 80% of window width
                height: windowHeight * 0.4, // 60% of window height
                title: `machine_id: ${machineId}`,
                cursor: cursorOpts,
                series: [
                    {},
                    {
                        label: "num_gpus_rented",
                        scale: "%",
                        stroke: "blue",
                        fill: "rgba(0,0,255,0.1)",
                        width: 1/window.devicePixelRatio,
                    },
                ],
            };
            let plotInstance2 = new uPlot(opts2, [plotData[2], plotData[3]], plotContainer);

            const opts3 = {
                width: windowWidth * 0.8, // 80% of window width
                height: windowHeight * 0.4, // 60% of window height
                title: `machine_id: ${machineId}`,
                cursor: cursorOpts,
                series: [
                    {},
                    {
                        label: "dph",
                        scale: "%",
                        stroke: "green",
                        fill: "rgba(0,255,0,0.1)",
                        width: 1/window.devicePixelRatio,
                    },
                ],
            };
            let plotInstance3 = new uPlot(opts3, [plotData[4], plotData[5]], plotContainer);

        }

        function staircaseFill(data) {
            let ts = data[0];
            let vals = data[1];
            let ts_filled = [];
            let vals_filled = [];

            // inserts a point directly preceding a change in status
            for (let i=0; i < ts.length - 1; i++) {
                ts_filled.push(ts[i]);
                ts_filled.push(ts[i + 1] - 1);
                vals_filled.push(vals[i]);
                vals_filled.push(vals[i]);
            }

            // add last elements
            ts_filled.push(ts.at(-1))
            vals_filled.push(vals.at(-1));

            return [ts_filled, vals_filled];
        }

        function unpackJSON(packed) {
            // console.log('unpackJSON', packed, packed.reliability_ts);
            console.time('unpack json');
            rel = [
                packed.reliability_ts.map(entry => entry.timestamp),
                packed.reliability_ts.map(entry => entry.reliability / 100),
            ]

            rent = [
                packed.rent_ts.map(entry => entry.timestamp),
                packed.rent_ts.map(entry => entry.num_gpus_rented)
            ]

            cost = [
                packed.cost_ts.map(entry => entry.timestamp),
                packed.cost_ts.map(entry => entry.dph_base / 1000),
            ]


            rent = staircaseFill(rent);
            cost = staircaseFill(cost);


            let data = [
                rel[0], rel[1],
                rent[0], rent[1],
                cost[0], cost[1],
            ]
            console.timeEnd('unpack json');
            console.log('data', data);
            return data
        }

        function fillna(data) {
            console.time('fillna');

            // Extracting timestamps and values for each timeseries
            let timestamps = [];
            let values = [];
            let numSeries = data.length / 2; // Assuming data is organized as [timestamps1, values1, timestamps2, values2, ...]

            // Initialize filledValues arrays
            let filledValues = [];
            for (let i = 0; i < numSeries; i++) {
                filledValues.push([]);
            }

            // Extract timestamps and values for each series
            for (let i = 0; i < numSeries; i++) {
                timestamps.push(data[i * 2]);
                values.push(data[i * 2 + 1]);
            }

            // Finding unique timestamps from all series
            let allTimestamps = [...new Set(timestamps.flat())].sort();

            // Fill missing values with last existing value
            for (let i = 0; i < allTimestamps.length; i++) {
                // Fill missing values for each series
                for (let j = 0; j < numSeries; j++) {
                    let index = timestamps[j].indexOf(allTimestamps[i]);

                    if (index !== -1) {
                        filledValues[j].push(values[j][index]);
                    } else {
                        filledValues[j].push(filledValues[j][filledValues[j].length - 1]);
                    }
                }
            }

            // Return the filled timeseries
            let filledData = [];
            for (let i = 0; i < numSeries; i++) {
                filledData.push(allTimestamps);
                filledData.push(filledValues[i]);
            }

            console.timeEnd('fillna');
            console.log('filledData', filledData);
            return filledData;
        }


        // Function to fetch data and update plot
        function handleSubmitForm() {
            // Get form values
            const machineId = document.getElementById("machine-id").value;
            const fromDate = document.getElementById("from-date").value;
            const toDate = document.getElementById("to-date").value;
            console.log(machineId, fromDate, toDate);

            let url = getUrl(machineId, fromDate, toDate);

            // Show loading spinner and disable button
            showLoading();

            // Fetch data from server
            fetch(url)
                .then(response => {
                    console.log(response);
                    return response.json();
                })
                .then(packed => unpackJSON(packed))
                .then(data => {
                    // console.log(data);
                    // console.log(data[0]);
                    // Hide loading spinner and enable button
                    hideLoading();

                    data = fillna(data);

                    if (plotInstance) {
                        updatePlot(data, machineId);
                    } else {
                        createPlot(data, machineId);
                    }
                })
                .catch(error => {
                    // Hide loading spinner and enable button
                    hideLoading();
                    console.error('Error fetching data:', error);
                });
        }

        // Event listener to update plot when the form is submitted
        plotForm.addEventListener("submit", function(event) {
            event.preventDefault();
            handleSubmitForm();
        });

    </script>

</body>
</html>
